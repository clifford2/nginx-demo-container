---
# SPDX-FileCopyrightText: Â© 2025 Clifford Weinmann <https://www.cliffordweinmann.com/>
# SPDX-License-Identifier: MIT-0

name: "Create and publish a container image"

"on":
  push:
    # Configures this workflow to run every time a change is pushed to the branch called `main`.
    # branches: ['main']
    # Pattern matched against refs/tags
    tags:
      - "*"  # Push events to every tag not containing /
  workflow_dispatch:


# fixme - Makefile vars - clean up
# Construct image names
# IMGDEVTAG := $(IMGBASETAG):$(DEVTAG)
# IMGRELTAG := $(IMGBASETAG):$(APP_VERSION)

# Defines two custom environment variables for the workflow.
# These are used for the Container registry domain, and a name for the Docker image that this workflow builds.
env:
  REGISTRY: "ghcr.io"
  # REPOBASE: "ghcr.io/clifford2"
  # REPOBASE: "${{ env.REGISTRY }}/${{ github.repository_owner }}"
  REPOBASE: "ghcr.io/${{ github.repository_owner }}"
  IMGBASETAG: "ghcr.io/${{ github.repository_owner }}/nginx-demo"

# There is a single job in this workflow. It's configured to run on the latest available version of Ubuntu.
jobs:
  build-and-push-image:
    runs-on: "ubuntu-24.04"

    # Sets the permissions granted to the `GITHUB_TOKEN` for the actions in this job.
    permissions:
      contents: "read"
      packages: "write"
      attestations: "write"
      id-token: "write"

    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4"

      # Uses the `docker/login-action` action to log in to the Container
      # registry using the account and password that will publish the packages.
      # Once published, the packages are scoped to the account defined here.
      - name: "Log in to the Container registry"
        uses: "docker/login-action@v3"
        with:
          registry: "${{ env.REGISTRY }}"
          username: "${{ github.actor }}"
          password: "${{ secrets.GITHUB_TOKEN }}"

      # This step uses [docker/metadata-action](https://github.com/docker/metadata-action#about)
      # to extract tags and labels that will be applied to the specified image. The `id` "meta"
      # allows the output of this step to be referenced in a subsequent step. The `images` value
      # provides the base name for the tags and labels.
      # - name: "Extract metadata (tags, labels) for Docker"
      #   id: "meta"
      #   uses: docker/metadata-action@v5
      #   with:
      #     images: ${{ env.IMGBASETAG }}
      #     tags: |
      #       type=ref,event=branch
      #       type=ref,event=pr
      #       type=semver,pattern={{version}}
      #       type=semver,pattern={{major}}.{{minor}}
      #       type=semver,pattern={{major}}

      # This step uses the `docker/build-push-action` action to build the image,
      # based on your repository's `Dockerfile`. If the build succeeds, it
      # pushes the image to GitHub Packages.
      # It uses the `context` parameter to define the build's context as the set
      # of files located in the specified path. For more information, see
      # [Usage](https://github.com/docker/build-push-action#usage) in the
      # README of the `docker/build-push-action` repository.
      # It uses the `tags` and `labels` parameters to tag and label the image
      # with the output from the "meta" step.
      # - name: Build and push Docker image
      #   id: "push"
      #   uses: docker/build-push-action@v6
      #   with:
      #     context: .
      #     file: Containerfile
      #     push: true
      #     tags: ${{ steps.meta.outputs.tags }}
      #     labels: ${{ steps.meta.outputs.labels }}

      - name: "Build & push container image"
        id: "build"
        run: |
          make CONTAINER_ENGINE=docker REPOBASE=${{ env.REPOBASE }} push-release

      - name: "Get container image digest"
        id: "inspect"
        run: |
          imagedigest="$(make CONTAINER_ENGINE=docker REPOBASE=${{ env.REPOBASE }} get-release-image-digest)"
          echo "imagedigest=${imagedigest}" >> $GITHUB_ENV

      # This step generates an artifact attestation for the image, which is an
      # unforgeable statement about where and how it was built. It increases
      # supply chain security for people who consume the image. For more
      # information, see [Using artifact attestations to establish provenance for
      # builds](/actions/security-guides/using-artifact-attestations-to-establish-provenance-for-builds).
      - name: "Generate artifact attestation"
        uses: "actions/attest-build-provenance@v2"
        with:
          subject-name: "${{ env.IMGBASETAG }}"
          # subject-digest: "${{ steps.push.outputs.digest }}"
          subject-digest: "${imagedigest}"
          push-to-registry: true
